<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
  <title>Ride Share App</title>
  <style>
    .search-bar-container {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      gap: 10px;
    }
    .input-field, .button, .popover-content, .modal-content {
      border-radius: 4px;
    }
    .input-field {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
    }
    .button {
      padding: 8px 12px;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .popover-content, .modal {
      display: none;
      position: absolute;
      z-index: 100;
      background: white;
      border: 1px solid #ddd;
    }
    .popover-content.active, .modal.active {
      display: block;
    }
    .modal {
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      margin: 10% auto;
      padding: 20px;
      width: 300px;
      background-color: #fff;
      text-align: center;
    }
  </style>
</head>
<body>

<div class="search-bar-container">
  <input type="text" id="destinationInput" class="input-field" placeholder="Enter destination...">
  <button id="pickupBtn" class="button">Pickup</button>
  <div id="pickupPopover" class="popover-content">
    <button id="currentLocationBtn" class="button">Current Location</button>
    <input type="text" id="pickupInput" class="input-field" placeholder="Enter pickup location...">
  </div>
  <select id="timeSelect" class="button">
    <option value="">Add Time</option>
    <option value="10">10 Minutes</option>
    <option value="15">15 Minutes</option>
    <option value="30">30 Minutes</option>
    <option value="45">45 Minutes</option>
  </select>
  <span id="timeCountdown" class="button"></span>
  <button id="bookBtn" class="button">Book $0.00</button>
  <button id="cancelBtn" class="button" style="display:none;">Cancel</button>
  <button id="refundBtn" class="button" style="display:none;">Refund</button>
</div>

<div id="bookingDetails"></div>

<div id="paymentModal" class="modal">
  <div class="modal-content">
    <h2>Confirm Booking</h2>
    <div id="paymentForm"></div>
    <button id="confirmPaymentBtn" class="button">Confirm Payment</button>
  </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOkJd62Hu9iEVlJ_LIIrakwbkm19cg8CU&libraries=places"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>
<script>
  let destination = '', pickupLocation = '', countdownTime = null, bookingAmount = 0, bookingId = null;
  let autocomplete, pickupAutocomplete, countdownInterval, stripe = Stripe('pk_test_51PKXFdLZTLOaKlNslmwEPt9pWm5uS9ZyOsr5gXeJKCmLal5nT1gofFJm2icRtOJgxEhs5265M6LRpSGPHEHydRna00CVialgWd'), elements;
  function initAutocomplete() {
    const destinationInput = document.getElementById('destinationInput');
    const pickupInput = document.getElementById('pickupInput');
    const bounds = new google.maps.LatLngBounds(
      { lat: 30.2817, lng: -89.4178 },
      { lat: 30.3617, lng: -89.2978 }
    );

    autocomplete = new google.maps.places.Autocomplete(destinationInput, { bounds, strictBounds: true, types: ['geocode'] });
    pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, { bounds, strictBounds: true, types: ['geocode'] });

    autocomplete.addListener('place_changed', () => setAddress(autocomplete, 'destinationInput', 'destination'));
    pickupAutocomplete.addListener('place_changed', () => setAddress(pickupAutocomplete, 'pickupBtn', 'pickupLocation'));
  }

  function setAddress(autocompleteInstance, elementId, addressVar) {
    const place = autocompleteInstance.getPlace();
    if (place.geometry) {
      window[addressVar] = place.formatted_address;
      document.getElementById(elementId).value = window[addressVar];
      if (addressVar === 'pickupLocation') document.getElementById('pickupPopover').classList.remove('active');
      updateBookingAmount();
    }
  }

  function updateBookingAmount() {
    if (!pickupLocation || !destination) return setBookingAmount(0);

    new google.maps.Geocoder().geocode({ address: pickupLocation }, (pickupResults, status) => {
      if (status === 'OK') {
        const pickupLatLng = pickupResults[0].geometry.location;
        new google.maps.Geocoder().geocode({ address: destination }, (destResults, status) => {
          if (status === 'OK') {
            const destLatLng = destResults[0].geometry.location;
            const distance = calculateDistance(pickupLatLng, destLatLng);
            setBookingAmount(calculatePrice(normalizeDistance(distance)));
          }
        });
      }
    });
  }

  function setBookingAmount(amount) {
    bookingAmount = amount;
    document.getElementById('bookBtn').innerText = `Book $${bookingAmount.toFixed(2)}`;
  }

  function calculateDistance(pickup, dest) {
    const R = 6371, dLat = (dest.lat() - pickup.lat()) * (Math.PI / 180), dLon = (dest.lng() - pickup.lng()) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(pickup.lat() * (Math.PI / 180)) * Math.cos(dest.lat() * (Math.PI / 180)) * Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)) * 0.621371; // Convert to miles
  }

  function normalizeDistance(distance) { return Math.min(Math.max(distance / 4, 0), 5); }
  function calculatePrice(normalizedDistance) { return 5 + normalizedDistance; }

  async function handleBook() {
    if (bookingAmount <= 0) return showToast('Select valid locations.', 'error');

    try {
      const { clientSecret, booking } = await fetch('/api/create-payment-intent', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: Math.round(bookingAmount * 100), pickup: pickupLocation, destination })
      }).then(res => res.json());

      bookingId = booking.id;
      showModal('paymentModal');
      elements = stripe.elements();
      elements.create('card').mount('#paymentForm');
      document.getElementById('confirmPaymentBtn').onclick = () => confirmPayment(clientSecret, booking);
    } catch (error) {
      showToast('Booking failed.', 'error');
    }
  }

  async function confirmPayment(clientSecret, booking) {
    const { error } = await stripe.confirmCardPayment(clientSecret, { payment_method: { card: elements.getElement('card') } });
    if (error) showToast(error.message, 'error');
    else handleSuccess(booking);
  }

  function handleSuccess(booking) {
    showToast('Payment successful!');
    updateBookingDetails(booking);
    toggleElements(['cancelBtn', 'refundBtn'], true);
    hideModal('paymentModal');
  }

  function updateBookingDetails(booking) {
    document.getElementById('bookingDetails').innerHTML = `
      <h3>Booking Details</h3>
      <p>Booking ID: ${booking.id}</p>
      <p>Pickup: ${booking.pickup}</p>
      <p>Destination: ${booking.destination}</p>
      <p>Amount: $${(booking.amount / 100).toFixed(2)}</p>
      <p>Status: ${booking.status}</p>
    `;
  }

  async function handleCancel() { await handleBookingAction('/api/cancel-booking', 'cancelled'); }
  async function handleRefund() { await handleBookingAction('/api/refund-booking', 'refunded'); }

  async function handleBookingAction(apiEndpoint, action) {
    if (!bookingId) return showToast(`No active booking to ${action}.`, 'error');

    try {
      const result = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ bookingId }) }).then(res => res.json());
      if (result.success) handlePostAction(result.booking, action);
      else showToast(`Failed to ${action} booking.`, 'error');
    } catch {
      showToast(`An error occurred while ${action}.`, 'error');
    }
  }

  function handlePostAction(booking, action) {
    showToast(`Booking ${action} successfully.`);
    updateBookingDetails(booking);
    toggleElements(['cancelBtn'], action !== 'cancelled');
    toggleElements(['refundBtn'], action === 'cancelled');
  }

  function toggleElements(ids, show) {
    ids.forEach(id => document.getElementById(id).style.display = show ? 'inline-block' : 'none');
  }

  function handleTimeSelectChange() {
    const value = parseInt(document.getElementById('timeSelect').value);
    if (value) {
      countdownTime = new Date(Date.now() + value * 60000);
      showToast(`${value} minutes added!`);
      startCountdown();
    }
  }

  function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  function updateCountdown() {
    const timeLeft = countdownTime - new Date();
    if (timeLeft <= 0) clearCountdown();
    else document.getElementById('timeCountdown').innerText = formatCountdown(timeLeft);
  }

  function clearCountdown() {
    clearInterval(countdownInterval);
    showToast('Time is up!');
    document.getElementById('timeSelect').value = '';
    document.getElementById('timeCountdown').style.display = 'none';
  }

  function formatCountdown(timeLeft) {
    const minutes = Math.floor(timeLeft / 60000), seconds = Math.floor((timeLeft % 60000) / 1000);
    return `${minutes}m ${seconds}s`;
  }

  function handlePickupLocationChange() { document.getElementById('pickupPopover').classList.toggle('active'); }
  function handleCurrentLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        pickupLocation = `${position.coords.latitude},${position.coords.longitude}`;
        document.getElementById('pickupBtn').innerText = 'Pickup: Current Location';
        document.getElementById('pickupPopover').classList.remove('active');
        updateBookingAmount();
      }, () => showToast('Location access denied.', 'error'));
    } else showToast('Geolocation not supported.', 'error');
  }

  function showModal(id) { document.getElementById(id).classList.add('active'); }
  function hideModal(id) { document.getElementById(id).classList.remove('active'); }
  function showToast(message, type = 'info') {
    Toastify({ text: message, duration: 3000, gravity: "top", position: 'right', backgroundColor: type === 'error' ? "#ff5f6d" : "#00b09b" }).showToast();
  }

  document.addEventListener('DOMContentLoaded', () => {
    initAutocomplete();
    document.getElementById('pickupBtn').onclick = handlePickupLocationChange;
    document.getElementById('currentLocationBtn').onclick = handleCurrentLocation;
    document.getElementById('timeSelect').onchange = handleTimeSelectChange;
    document.getElementById('bookBtn').onclick = handleBook;
    document.getElementById('cancelBtn').onclick = handleCancel;
    document.getElementById('refundBtn').onclick = handleRefund;
  });
</script>

</body>
</html>

VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51PKXFdLZTLOaKlNslmwEPt9pWm5uS9ZyOsr5gXeJKCmLal5nT1gofFJm2icRtOJgxEhs5265M6LRpSGPHEHydRna00CVialgWd
VITE_GOOGLE_MAPS_API_KEY=AIzaSyCOkJd62Hu9iEVlJ_LIIrakwbkm19cg8CU
FIREBASE_SERVICE_ACCOUNT_KEY={"type": "service_account", "project_id": "rabbit-2ba47", "private_key_id": "a70ea52abd76760d08a92c5df38ed324723d82da", "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDHANkZ2qBBOpgt\nbJrvA70s8clhwwUoSXDeiZI4Sv/ikk6z3MSaPVvtuGwA3BnvkUl0Hb1MB7HmOh0u\n3TcmV6EEE6XV7vQBCwFzhAVNibdTZcEMU7IUbR4wMB2qCIU0fAVOhgHz2WABW0SP\nZAcnt4MOj8oba96Ne/vONMON5zgYZOguWuyyS+h64Wxygryx06/zYG/wFhZdv4k1\nR2NNdU76jnJOqagdnZILHRW1RGV5xNT/lhD5QQ6gncFKPI1uCMaTKQZVB6a7RI9+\ndVr7EZBljOdNpEI9WAqgTwS7SWj5rrqCR9ShsGK6Omodz8MThIWBqG/G7QL5sm92\n3GdU+Qz5AgMBAAECggEAJoEfAJYhKM3WEP/xEGsYSOB1lyFdV5iyKpTSwmqcjTHC\n4aFHNxLFPT9QQnBT4lspq7pvXI0mmkXHTMCHwbb11CybC0RDWQpQmxHB1uldG9lV\n23U8QSCF1UwSCUrBv1B51GIwcYavQUPwBZCUo9YpmQEwWVLrSlPheloSNlw1Kd7R\nA/gPvMAhgrkeFh3i0sm04z23TdD9cWu6XWW3jfPPCFkiSbRvKDvK+a+Hq1TXqmdd\nDVUd4lVPxXgTFReRAVJF5sYZV8ITcPsWoXsLechzYGCeM+m/miewwLwPelujZZY4\nA6tXIqgKk3ZFANQnp8W3K4NWfLF94LfOMIcA8/AtWwKBgQDl0hh8rM+k8Kfu8RLL\nJtUx0vaPpBN7Y6q+f/gnAg/9jsIsimcay2NfqPFHsAhqpYC3JCuDISYRvRI23/1w\ngTIn5wCqFcQRb2v00Q94Wql8tMM2YEr1MQCFCtDB0Ad7XlOFAHybuLEodhIJBVxA\nxJxmI01AuLCmyo9i/vizuhlvbwKBgQDdrBK3y5ZnExmQ5upMCMcfStPVoGwgFNFB\nbySO3Kor0R7cYD3kKyx5ekarIKE8NF9sJODx7fcxCkUKnlwutBAPxwniK5eLBOnN\nczDpXOhpbzxpGI2b6AbpPF1mfiLvBo4FeIUpgaN0yFCLgnABsvF4kRb089mQ+5y5\n/d3L/muWFwKBgQCSG6THtpH4WataJFd/YjvOBkIMhhKAspd9rxvTqOMDn3vhF0h/\nZ2jRCzYCDm77ZibTyCIFptBuHJb03ihhGzII3jq050uUjhLDPRopuPHhv4YQDt34\nzeN3sa2QWjI3g3tzpiCSW7P9djr3EzpYTubjpHPbvs9H6qWIGXOBx8Gd7wKBgHwh\nbn3jkH550Jg25r7bL34Tbdozsjioz6Efts4VPWm5+dkYP7A0iPwhf882P3OyNDkf\n0aNISWL5yD2w/hfdFx1urNcs5/ieMLqupZYYQ8E+3ApSCIJkhPI4rmjFe5R0DDV+\nDrt2b+zme0wUJ9qbtOJ6BOv4XT312AbC5V/lQaPTAoGAUaKIjdohQDT6jFUzvNDH\nEgsRAi8WeUGyy+AU+j9QgqrUZDmhn72Em4cPsM813kCbCVO9I3XAVDld+fwxYYze\ncEYOn5jEFHHrzxbNvr4QnfPMnNMeh0Ntb3W4pGlLleeXZfUSP4fAgAhKOFsdw8Su\ng5RUNv3gLAYw7cJNOz08lWg=\n-----END PRIVATE KEY-----\n", "client_email": "firebase-adminsdk-xvmgw@rabbit-2ba47.iam.gserviceaccount.com", "client_id": "106153603425470812867", "auth_uri": "https://accounts.google.com/o/oauth2/auth", "token_uri": "https://oauth2.googleapis.com/token", "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs", "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-xvmgw%40rabbit-2ba47.iam.gserviceaccount.com", "universe_domain": "googleapis.com"}
